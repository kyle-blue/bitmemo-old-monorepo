apiVersion: v1
kind: ServiceAccount
metadata:
  name: certificate-renewal
  namespace: app
automountServiceAccountToken: true
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: certificate-renewal
  namespace: app
spec:
  schedule: "0 */3 * * *" # Run once every 3 hours
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    metadata:
      name: certificate-renewal
    spec:
      backoffLimit: 3
      template:
        metadata:
          name: certificate-renewal
          labels:
            name: certificate-renewal
        spec:
          restartPolicy: OnFailure
          serviceAccountName: certificate-renewal
          containers:
            - name: certificate-renewal
              image: registry.gitlab.com/bit-memo/deprecated/bitmemo-old-monorepo/cert-renewal:latest
              imagePullPolicy: Always
              env:
                - name: WEBSITE
                  value: "bitmemo.io"
                - name: "SERVER"
                  value: "production"
                - name: SUBDOMAINS
                  value: "www traefik admin argocd jira jenkins mail"
              # command: ["bash", "-c", "--"]
              # args: ["while true; do sleep 30; done;"]
              ports:
                - containerPort: 80 # Expose port 80 to container
          imagePullSecrets:
            - name: registry-creds
---
apiVersion: v1
kind: Service
metadata:
  name: certificate-renewal
  namespace: app
spec:
  selector:
    name: certificate-renewal
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: certificate-renewal
  namespace: app
rules:
  - apiGroups: [""]
    resources: ["secrets"] # // TODO: Add specific names here
    verbs: ["create", "update", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: certificate-renewal
  namespace: app
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: certificate-renewal
subjects:
  - apiGroup: ""
    kind: ServiceAccount
    name: certificate-renewal
    namespace: app
